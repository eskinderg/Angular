<div class="header">
    <div class="form-group">
        <select
            [value]="selectedUserId$ | async"
            (change)="updateSelectedUser($event)"
            [class.active]="selectedUserId$.value"
            class="userid-select">
            <option [value]="''">All ({{ TotalNotesCount | async }})</option>
            @for (user of Owners | async; track trackByUserId(user)) {
                <option [value]="user.user_id">{{ user.owner }} ({{ user.total_notes }})</option>
            }
        </select>
    </div>
    <div class="search-wrapper">
        <input
            type="text"
            placeholder="Search"
            [class.active]="searchTerm$.value.length"
            [value]="searchTerm$.value"
            (input)="onSearchInput($event)" />
        @if (searchTerm$.value) {
            <button class="clear-btn" (click)="clearSearch()">Ã—</button>
        }
    </div>

    @if (selectedNotes$ | async; as selectedNotes) {
        @if (selectedNotes.length) {
            <button class="selection-btn" (click)="openSelectedNotesDialog()">
                Selected {{ selectedNotes.length }}
            </button>
        }
    }

    @if (searchTerm$.value || selectedUserId$.value || selectedNotes$.value.length) {
        <svg class="clear-filter" (click)="clearFilter()" viewBox="0 0 24 24" fill="none">
            <g clip-path="url(#clip0_429_11083)">
                <path
                    d="M7 7.00006L17 17.0001M7 17.0001L17 7.00006"
                    stroke="#8f8f8f"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round" />
            </g>
            <defs>
                <clipPath>
                    <rect width="24" height="24" fill="white" />
                </clipPath>
            </defs>
        </svg>
    }
</div>

<div class="outer">
    <div class="left">
        <app-piechartradial
            [data]="data | async"
            [selectedUserId]="selectedUserId$.value"
            (pieClickOutside)="onPieChartClear()"
            (pieClick)="onPieChartClick($event)"></app-piechartradial>
    </div>
    <div>
        <table>
            <tr>
                <th class="checkbox">
                    <input
                        type="checkbox"
                        (change)="toggleSelectAll($event)"
                        [checked]="areAllNotesSelected()" />
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'header' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'header' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('header')">
                    Header
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'owner' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'owner' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('owner')">
                    Owner
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'active' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'active' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('active')">
                    Active
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'readonly' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'readonly' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('readonly')">
                    Readonly
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'archived' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'archived' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('archived')">
                    Archived
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'pinned' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'pinned' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('pinned')">
                    Pinned
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'date_archived' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'date_archived' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('date_archived')">
                    Date Archived
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'date_deleted' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'date_deleted' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('date_deleted')">
                    Date Deleted
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'spell_check' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'spell_check' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('spell_check')">
                    Spell Check
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'colour' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'colour' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('colour')">
                    Colour
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'date_created' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'date_created' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('date_created')">
                    Created
                </th>
                <th
                    [class.sorted-asc]="
                        (sortField$ | async) === 'date_modified' && (sortDirection$ | async) === 'asc'
                    "
                    [class.sorted-desc]="
                        (sortField$ | async) === 'date_modified' && (sortDirection$ | async) === 'desc'
                    "
                    (click)="updateSort('date_modified')">
                    Last Modified
                </th>
            </tr>
            @for (note of filteredNotes$ | async; track trackByFn($index, note)) {
                <tr
                    (click)="onClick(note)"
                    class="row"
                    [class.inactive]="!note.active"
                    [class.selected]="isNoteSelected(note)">
                    <td class="checkbox" (click)="$event.stopPropagation()">
                        <label>
                            <input
                                type="checkbox"
                                [checked]="isNoteSelected(note)"
                                (change)="toggleNoteSelection(note, $event)" />
                        </label>
                    </td>
                    <td>{{ note.header }}</td>
                    <td>{{ note.owner }}</td>
                    <td>{{ note.active }}</td>
                    <td>{{ note.readonly }}</td>
                    <td>{{ note.archived }}</td>
                    <td>{{ note.pinned }}</td>
                    <td>{{ note.date_archived | date: 'medium' }}</td>
                    <td>{{ note.date_deleted | date: 'medium' }}</td>
                    <td>{{ note.spell_check }}</td>
                    <td>{{ note.colour }}</td>
                    <td>{{ note.date_created | date: 'medium' }}</td>
                    <td>{{ note.date_modified | date: 'medium' }}</td>
                </tr>
            }
        </table>
    </div>
</div>

@if (showSelectedNotesDialog) {
    <app-selected-notes-dialog
        [selectedNotes]="selectedNotes$ | async"
        (closed)="closeSelectedNotesDialog()"
        (bulkUpdate)="openBulkUpdateDialog()"></app-selected-notes-dialog>
}

@if (showBulkUpdateDialog) {
    <app-bulk-update-dialog
        [users]="Owners | async"
        (closed)="closeBulkUpdateDialog()"
        (updated)="applyBulkUpdate($event)"></app-bulk-update-dialog>
}

@if (SelectedNote | async) {
    <app-edit-note-dialog
        [note]="SelectedNote | async"
        (closed)="onClose()"
        (saved)="onSaved($event)"></app-edit-note-dialog>
}
